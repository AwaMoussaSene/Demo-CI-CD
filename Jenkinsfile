pipeline {
    agent any

    options {
        timestamps()
    }

    triggers {
        githubPush() // D√©clenchement automatique sur push GitHub
    }

    stages {
        stage("Checkout") {
            steps {
                echo "üì• R√©cup√©ration du code source..."
                checkout scm
            }
        }

        stage("Verify Docker") {
            steps {
                echo "üîç V√©rification du daemon Docker..."
                bat """
                    docker info || (
                        echo Docker daemon non disponible
                        exit 1
                    )
                """
            }
        }

        stage("Build & Push Docker Image") {
            steps {
                script {
                    // Tag s√©curis√© bas√© sur la branche ou master
                    def src = (env.BRANCH_NAME ?: env.GIT_BRANCH ?: 'master')
                    def safeTag = src.replaceAll('[^A-Za-z0-9._-]', '-')
                    def imageName = "awamoussasene/demo-ci-cd-java"
                    def imageTag = "${imageName}:${safeTag}-${env.BUILD_NUMBER}"
                    def latestImageTag = "${imageName}:latest"

                    echo "üê≥ Construction de l'image Docker: ${imageTag}"

                    // Build l'image
                    bat "docker build -t ${imageTag} ."

                    // Login Docker Hub avec les credentials Jenkins
                    withCredentials([usernamePassword(credentialsId: 'java-dockerhub-creds',
                                                      usernameVariable: 'DOCKERHUB_USR',
                                                      passwordVariable: 'DOCKERHUB_PSW')]) {
                        bat 'echo %DOCKERHUB_PSW% | docker login -u %DOCKERHUB_USR% --password-stdin'
                    }

                    // Push des tags
                    bat "docker push ${imageTag}"
                    bat "docker tag ${imageTag} ${latestImageTag}"
                    bat "docker push ${latestImageTag}"

                    echo "‚úÖ Image Docker construite et publi√©e avec succ√®s."
                }
            }
        }

        stage("Deploy to Render") {
            steps {
                echo "üöÄ D√©clenchement du d√©ploiement sur Render..."
                withCredentials([string(credentialsId: 'java-render-webhook', variable: 'HOOK_URL')]) {
                    bat 'curl -i -X POST "%HOOK_URL%"'
                }
                echo "‚úÖ D√©ploiement d√©clench√©."
            }
        }

        stage("Verify Application (optionnel)") {
            steps {
                withCredentials([string(credentialsId: 'java-render-app-url', variable: 'APP_URL')]) {
                    bat 'curl -I "%APP_URL%" || echo "‚ö†Ô∏è Impossible de contacter l‚Äôapplication"'
                }
            }
        }
    }

    post {
        always {
            cleanWs()
            echo "‚ú® Pipeline termin√©."
        }
        success {
            echo "üéâ Succ√®s: Le pipeline s'est termin√© avec succ√®s!"
        }
        failure {
            echo "‚ùå √âchec: Le pipeline a √©chou√©."
        }
    }
}
