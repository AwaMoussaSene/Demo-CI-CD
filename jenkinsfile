pipeline {
    agent any

    options {
        timestamps()
    }

    environment {
        // Credentials Docker Hub
        DOCKERHUB = credentials('java-dockerhub-creds')
        IMAGE_NAME = "${DOCKERHUB_USR}/demo-ci-cd-java"
    }

    triggers {
        githubPush() // D√©clenchement automatique sur push GitHub
    }

    stages {
        stage("Checkout") {
            steps {
                echo "üì• R√©cup√©ration du code source..."
                checkout scm
            }
        }

        stage("Verify Docker") {
            steps {
                echo "üîç V√©rification du daemon Docker..."
                sh """
                    docker info || (
                        echo Docker daemon non disponible
                        exit 1
                    )
                """
            }
        }

        stage("Build & Push Docker Image") {
            steps {
                script {
                    def src = (env.BRANCH_NAME ?: env.GIT_BRANCH ?: 'main')
                    def safeTag = src.replaceAll('[^A-Za-z0-9._-]', '-')
                    def imageTag = "${IMAGE_NAME}:${safeTag}-${env.BUILD_NUMBER}"
                    def latestImageTag = "${IMAGE_NAME}:latest"

                    echo "üê≥ Construction de l'image Docker: ${imageTag}"

                    // Build l'image
                    sh "docker build -t ${imageTag} ."

                    // Login Docker Hub
                    sh """
                        echo ${DOCKERHUB_PSW} | docker login -u ${DOCKERHUB_USR} --password-stdin
                    """

                    // Push des tags
                    sh "docker push ${imageTag}"
                    sh "docker tag ${imageTag} ${latestImageTag}"
                    sh "docker push ${latestImageTag}"

                    echo "‚úÖ Image Docker construite et publi√©e avec succ√®s."
                }
            }
        }

        stage("Deploy to Render") {
            steps {
                echo "üöÄ D√©clenchement du d√©ploiement sur Render..."
                withCredentials([string(credentialsId: 'java-render-webhook', variable: 'HOOK_URL')]) {
                    sh "curl -i -X POST \"${HOOK_URL}\""
                }
                echo "‚úÖ D√©ploiement d√©clench√©."
            }
        }

        stage("V√©rifier Application (optionnel)") {
            steps {
                withCredentials([string(credentialsId: 'java-render-app-url', variable: 'APP_URL')]) {
                    sh "curl -I \"${APP_URL}\" || echo '‚ö†Ô∏è Impossible de contacter l‚Äôapplication'"
                }
            }
        }
    }

    post {
        always {
            cleanWs()
            echo "‚ú® Pipeline termin√©."
        }
        success {
            echo "üéâ Succ√®s: Le pipeline s'est termin√© avec succ√®s!"
        }
        failure {
            echo "‚ùå √âchec: Le pipeline a √©chou√©."
        }
    }
}
